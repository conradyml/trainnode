<!doctype html>
<html lang=en>
<head>
<meta charset=utf-8>
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" /> 
<meta name="mobile-web-app-capable" content="yes">
<title>Train Control</title>
<style type="text/css"> 
  :root{
    --slider_background:blue;
  }
	body {
		background-color: #000000;
		margin: 0px;
	}

    .flex-parent-element {
      display: flex;
      width:80%;
    }

    .flex-child-element {
      flex: 2;
      border: 2px solid blueviolet;
      margin: 10px;
    }

    .flex-child-element:first-child {
        flex: 1;
        margin-right: 20px;
    }

   #messages{
     color:white;
     }
	.container {
		width:auto;
		text-align:center;
		background-color:#ff0000;
	}
	
	.cam_button {
		display:inline-block;
		height:80px;
		width:80px;
		background-color: transparent;
		border-radius: 100%;
		border: 7px;
		border-style: solid;
		border-color: white;
		text-align:center;
		font-size: 16px;
		cursor: pointer;
	}
	
	.cam_button:active {
		background-color: gray;
	}
  
   
	#sidenav {
		color: #fff;
		height: 100%;
		min-width:150px;
		background-color: #333;
		padding-top: 20px;
		padding-left: 5px;
		padding-right: 5px;
    padding-bottom: 5px;
		font-family: 'Roboto', sans-serif;
		text-align:center;
        border:solid white;
	}

	#center {
        color:#ffffff;
        height:100%;
        min-width:150px;
        border: solid red;

    }
    #Throttle0_container{
    --slider_background:#d3ff12;
  }
  #Throttle3_container{
    --slider_background:#2e944d;
  }
  #Throttle5_container{
    --slider_background:#3d93e4;
  }

  .ThrottleControl{
    display: inline-block;
    width: 75px;
    border:1px solid var(--slider_background);
    padding:2px;
    
  }

  #messageContainer{
    height:300px;
    width:100%;
    padding:5px;
  }
  #contentContainer{
      height: 400px;
      width:100%;
  }
  #freeform_area{
    padding-left:20px;
    text-align:left;
  }
  #freeform_area > form > label{
    padding-right: 10px;
  }
  #freeform_area > form{
    display:inline-block;
  }
  #freeform_button{display: inline-block;
    border: 2px solid orange;
    height: 40px;
    width: 40px;
    border-radius: 20px;}

</style>
<style>
    /* this style section allows checkboxes that look like sliders. */
    /* from https://www.w3schools.com/howto/howto_css_switch.asp */
    /* The switch - the box around the slider */
.switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 24px;
  margin-bottom:5px;
}

/* Hide default HTML checkbox */
.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

/* The slider */
.switchslider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #d3d3d3;
  opacity: 0.7;
  -webkit-transition: .4s;
  transition: .4s;
}
.switchslider:hover{
  opacity: 1;
}
.switchslider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 2px;
  bottom: 2px;
  background-color: white;
  border:1px solid darkslategray;
  -webkit-transition: .4s;
  transition: .4s;
}

input:checked + .switchslider {
  background-color: var(--slider_background);
}

input:focus + .switchslider {
  box-shadow: 0 0 1px var(--slider_background);
}

input:checked + .switchslider:before {
  -webkit-transform: translateX(26px);
  -ms-transform: translateX(26px);
  transform: translateX(26px);
}

/* Rounded sliders */
.switchslider.round {
  border-radius: 26px;
}

.switchslider.round:before {
  border-radius: 50%;
}
</style>
<style>
    /* this style section used for range slider controls. */
    /* from https://www.w3schools.com/howto/howto_js_rangeslider.asp  */
    .slidecontainer {
      margin-top:5px;
}

/* The slider itself */
.slider {
  writing-mode: vertical-lr; 
  direction: rtl;
 -webkit-appearance: none;
  appearance: none;
  width: 10px; /* Full-width */
  height: 150px; /* Specified height */
  background: #d3d3d3; /* Grey background */
  outline: none; /* Remove outline */
  opacity: 0.7; /* Set transparency (for mouse-over effects on hover) */
  -webkit-transition: .2s; /* 0.2 seconds transition on hover */
  transition: opacity .2s;
}

/* Mouse-over effects */
.slider:hover {
  opacity: 1; /* Fully shown on mouse-over */
}

/* The slider handle (use -webkit- (Chrome, Opera, Safari, Edge) and -moz- (Firefox) to override default look) */
.slider::-webkit-slider-thumb {
  -webkit-appearance: none; /* Override default look */ 
  appearance: none;
  width: 25px; /* Set a specific slider handle width */
  height: 25px; /* Slider handle height */
  transform: translateX(-6px); 
  border-radius:50%;
  background: var(--slider_background); /* Green background */
  cursor: pointer; /* Cursor on hover */
}

.slider::-moz-range-thumb {
  width: 25px; /* Set a specific slider handle width */
  height: 25px; /* Slider handle height */
  border-radius:50%;
  background: var(--slider_background); /* Green background */
  cursor: pointer; /* Cursor on hover */
}
</style>

</head>
<script src="/socket.io/socket.io.js"></script>
<script>
var socket = io(); // comment this out for better debugging
var sendFlag = false;

use128BitSpeed = false;

let ThrottleDictionary = new Object();
  ThrottleDictionary["Throttle0"]=0x00;
  ThrottleDictionary["Throttle3"]=0x03;
  ThrottleDictionary["Throttle5"]=0x05;

function init(){
	
	
	socket.on('message', function(msg){
		console.log("message returned from server:"+msg)
		LogMessage(msg);
	});
 
  var throttles = document.getElementsByClassName("slider");
  for (let i = 0; i<throttles.length; i++){
    setThrottleListener(throttles[i]);
  }

  function setThrottleListener(throttle){
    throttle.addEventListener("input",function(event){
      output = event.target.id+"_val"
      document.getElementById(output).innerHTML = event.target.value;
    });
    throttle.addEventListener("change",function(event){
      ThrottleChange(event.target)
    });
  }

  var lights = document.getElementsByClassName("lights");
  for (let i = 0; i<lights.length; i++){
    setLightListenter(lights[i]);
  }

  function setLightListenter(light){
   light.addEventListener("change",function(event){
     LightChange(event.target)
    });
  }


var button = document.getElementById("freeform_button");
  button.addEventListener("click", function(){
    var Addr = document.getElementById("ffAddress").value;
    var B1 = document.getElementById("ffByte1").value;
    var B2 = document.getElementById("ffByte2").value;
    if ((Addr.trim()!== "") && (B1.trim()!== "")){
      if (B2.trim()!== ""){
        Addr = parseInt(Addr,2);
        B1 = parseInt(B1,2);
        B2 = parseInt(B2,2);
        LogMessage(" Writing 3 word message: "+parseInt(Addr, 16)+" "+B1+" "+B2+".")
        sendCommand(Addr,[B1,B2]);
      } else {
        Addr = parseInt(Addr,2);
        B1 = parseInt(B1,2);
        LogMessage(" Writing 2 word message: "+Addr+" "+B1)
        sendCommand(Addr,[B1]);
       }
    } else {
      LogMessage(" Need at least an address and 1st byte.")

    }
  });

}

function fireOnReady() { 
	// execute after DOM is loaded
  //
	init();
}

if (document.readyState === 'complete') {
    fireOnReady();
} else {
    document.addEventListener("DOMContentLoaded", fireOnReady);
}

// communication functions

function throttle128(id,val){
	socket.emit("throttle128",id,val);
  console.log("Sending 128 bit speed control with id: "+id+" and value: "+val);
}

function throttle16(id,val){
	socket.emit("throttle",id,val);
  console.log("Sending 16 bit speed control with id: "+id+" and value: "+val);
}

function lights(cb,val){
	socket.emit("lights",val,cb.checked);
}
function estop(){
	socket.emit("eStop");
	console.log("estop clicked");
}
function handleButton(button,action) {
   socket.emit(utton.id, action);
}
function handleSlider(cb) {
   socket.emit(cb.id, cb.checked);
}
function sendCommand(addr,command){
  //command is a byte array.
   socket.emit("command",addr,command);
}

function setAddress(addr,newAddr){
  var add1 = document.getElementById('oldAddress').value;
  var add2 = document.getElementById('newAddress').value;
  if ((add1.trim()!== "") && (add2.trim()!== "")){
    socket.emit("setAddr",add1,add2);
    } else {
      LogMessage(" Need two addresses.")

    }
    
}




// Utility Functions
function LogMessage(msg){
  const list = document.getElementById('messages');
		const newItem = document.createElement('li');
		newItem.textContent = msg;
		list.appendChild(newItem);
  }	

function ThrottleChange(throttle){
    console.log("Throttle: "+throttle.id+" change to value:"+throttle.value);
    var hexid = ThrottleDictionary[throttle.id];
    var speed = throttle.value;
    if (use128BitSpeed==true){
      if (speed < 0) {
        //reverse
        speed = Math.round(Math.abs(speed*126/100));
      } else {
        speed = Math.round(Math.abs(speed*126/100));
        speed = (0x80^speed); //add 8th bit based on FWD motion.
      }
      throttle128(hexid,speed);
    } else {
    
      if (speed < 0) {
        speed = Math.round(Math.abs(speed*15/100));
        speed = (0x40^speed); // 16 bit reverse speed starts with 0x40
      } else {
        speed = Math.round(Math.abs(speed*15/100));
        speed = (0x60^speed); //
      }
      throttle16(hexid,speed);
    }
}

function LightChange(light){
  console.log("Light: "+light.id+" change to value:"+light.value);
  var hexid = ThrottleDictionary[light.id.substring(0,9)];
  lights(light,hexid);
}

/*function setAddress(){
  var add1 = document.getElementById('oldAddress').value;
  var add2 = document.getElementById('newAddress').value;
  if ((add1.trim()!== "") && (add2.trim()!== "")){
    SetAddr(add1,add2);
    } else {
      LogMessage(" Need at least an address and 1st byte.")

    }
}*/



</script>

<body scroll="no" class="flex-parent-element">
<div id="sidenav" class="flex-child-element">

        <div class="cam_button" id="button7" type="button" onClick="estop();"><br/>ESTOP</div>
        <br/>
        <hr style="width:75%"/>

        <div id="Throttle0_container" class="ThrottleControl">
          <span class="throttleLabel">Master</span>
          <label class="switch">
            <input type="checkbox" id="Throttle0_lights" class="lights">
            <span class="switchslider round"></span>
          </label>
          <div class=ThrottleValue id="Throttle0_val">000</div>
            <div class="slidecontainer">
               <input type="range" min="-100" max="100" value="0" step="1" list="my-detents" class="slider" id="Throttle0">
            </div>
        </div>
        <div id="Throttle3_container" class="ThrottleControl">
          <span class="throttleLabel">Engine 03</span>
          <label class="switch">
            <input type="checkbox" id="Throttle3_lights" class="lights">
            <span class="switchslider round"></span>
          </label>
          <div class=ThrottleValue id="Throttle3_val">000</div>
            <div class="slidecontainer">
               <input type="range" min="-100" max="100" value="0" step="1" list="my-detents" class="slider" id="Throttle3">
            </div>
        </div>
        <div id="Throttle5_container" class="ThrottleControl">
          <span class="throttleLabel">Engine 05</span>
          <label class="switch">
            <input type="checkbox" id="Throttle5_lights" class="lights">
            <span class="switchslider round"></span>
          </label>
          <div class=ThrottleValue id="Throttle5_val">000</div>
            <div class="slidecontainer">
               <input type="range" min="-100" max="100" value="0" step="1" list="my-detents" class="slider" id="Throttle5" >
            </div>
        </div>
        <hr style="width:75%"/>
        <div id ="freeform_area">
          <div id ="freeform_button" class="button"></div>
          <form>
            <label for="Address">Address:</label><input type="text" id="ffAddress" name="Address" size="6"><br/>
            <label for="Byte1:">Byte1</label> <input type="text" id="ffByte1" name="Byte1" size = 8> <br/>
            <label for="Byte2:">Byte2</label> <input type="text" id="ffByte2" name="Byte2" size = 8>
          </form>
        </div>
        <hr style="width:75%"/>
        <div id ="address_area">
            <label for="oldAddress">Old Address:</label><input type="text" id="oldAddress" name="oldAddress" size="6"><br/>
            <label for="newAddress">New Address:</label><input type="text" id="newAddress" name="newAddress" size="6"><br/>
            <button id = "setAddress" onClick="setAddress();">Set Address</button>
        </div>

</div>
<div id = "center" class="flex-child-element">
   <div id ="contentContainer">
      Something Goes Here.
  </div>
  <div id = "messageContainer">
    <span class="title">Messages</span>
    <ul id="messages"></ul>
  </div>  
</div>

<datalist id="my-detents" style="display:none">
  <option value="50">
    <option value="0">
  <option value="-50">
</datalist>
</body>
</html>
